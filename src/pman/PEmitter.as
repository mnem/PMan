package pman
{
    import flash.display.BitmapData;
    import flash.geom.Rectangle;

    /**
     * Particle emitter.
     *
     * @author David Wagner
     *
     */
    public class PEmitter
    {
        private var _particles :Vector.<P>;
        private var _x :int;
        private var _y :int;
        private var _bd :BitmapData;

        private var _rleft :int;
        private var _rright :int;
        private var _rtop :int;
        private var _rbottom :int;

        public var particleCount:int;

        /**
         * Constructor
         *
         * @param p_particleCount Total number of particles
         * @param p_x Emitter X position
         * @param p_y Emitter Y position
         * @param p_bd BitmapData object to draw the particles into
         * @param p_r Rect containing the particles
         * @param p_colours Colour array from which a particles colour is randomly chosen.
         * @param p_bounce Indicates if the particles should bounce until dead.
         *
         */
        public function PEmitter( p_particleCount :int, p_x :Number, p_y :Number, p_bd :BitmapData, p_r :Rectangle, p_colours :Vector.<int>, p_bounce :Boolean, gfx:int ) :void
        {
            if(p_bounce)
            {
                update = updateBounce;
            }
            else
            {
                update = updateNoBounce;
            }
            _bd = p_bd;
            _rleft = p_r.left;
            _rright = p_r.right;
            _rtop = p_r.top;
            _rbottom = p_r.bottom;
            _x = p_x;
            _y = p_y;
            _particles = new Vector.<P>( p_particleCount, true );

            for( var i :int = 0; i < p_particleCount; i++ )
            {
                var p :P = new P(p_colours[Math.round((p_colours.length - 1) * RANDOM[ridx++])], gfx);

                emitParticle( p );

                _particles[i] = p;
            }
        }

        /**
         * Emits the passed particle, resetting it to initial values.
         *
         * @param p_p
         *
         */
        private function emitParticle( p_p :P ) :void
        {
            p_p.x = _x + (-10 + (RANDOM[ridx++] * 20));
            p_p.y = _y + (-10 + (RANDOM[ridx++] * 20));

            if( p_p.x < _rleft ) p_p.x = _rleft;
            if( p_p.x >= _rright ) p_p.x = _rright - 1;

            if( p_p.y < _rtop ) p_p.y = _rtop;
            if( p_p.y >= _rbottom ) p_p.y = _rbottom - 1;

            p_p.vx = -10 + (RANDOM[ridx++] * 20);
            p_p.vy = -10 + (RANDOM[ridx++] * 20);

            p_p.life = P.LIFE_MAX * RANDOM[ridx++];

            // Play it safe and reset the random index pointer when we're quite far from the end
            if(ridx > RANDOM.length - 32)
            {
                ridx = 0;
            }
        }

        protected function updateBounce():void
        {
            var i:int = _particles.length;
            var p:P;
            var px:int;
            var py:int;
            var pl:int;

            particleCount = 0;

            while(i--)
            {
                p = _particles[i];

                px = p.x + p.vx;
                py = p.y + p.vy;
                pl = p.life - 1;

                // Apply "Gravity"
                p.vy += 1;

                // Apply bounce and dampening
                if( px < _rleft )
                {
                    px -= p.vx;
                    p.vx *= -0.9;
                }
                if( px > _rright )
                {
                    px -= p.vx;
                    p.vx *= -0.9;
                }

                if( py < _rtop )
                {
                    py -= p.vy;
                    p.vy *= -0.8;
                }
                if( py > _rbottom )
                {
                    py -= p.vy;
                    p.vy *= -0.8;
                }

                if( pl <= 0 )
                {
                    // It's dead
                    emitParticle( p );
                }
                else
                {
                    // Draw it
                    p.x = px;
                    p.y = py;
                    p.life = pl;
                    particleCount++;
                    p.draw( _bd );
                }
            }
        }

        protected function updateNoBounce():void
        {
            var i:int = _particles.length;
            var p:P;
            var px:int;
            var py:int;
            var pl:int;

            particleCount = 0;

            while(i--)
            {
                p = _particles[i];

                px = p.x + p.vx;
                py = p.y + p.vy;
                pl = p.life - 1;

                // Apply "Gravity"
                p.vy += 1;

                // Bounds check
                if( px < _rleft   ) pl = 0;
                if( px > _rright  ) pl = 0;
                if( py < _rtop    ) pl = 0;
                if( py > _rbottom ) pl = 0;

                if( pl <= 0 )
                {
                    // It's dead
                    emitParticle( p );
                }
                else
                {
                    // Draw it
                    p.x = px;
                    p.y = py;
                    p.life = pl;
                    particleCount++;
                    p.draw( _bd );
                }
            }
        }

        /**
         * Updates all particles.
         *
         */
        public var update:Function;

        // Handy dandy random numbers courtesy of http://www.random.org shoved into a 1k lookup table
        protected var ridx:int = 0;
        protected static const RANDOM:Vector.<Number> = Vector.<Number>([
            0.7286324937,   0.2167717902,   0.1500899831,   0.2802217261,   0.0491422679,   0.8955717829,   0.9948356123,   0.4162196881,   0.1178179981,   0.2746504957,   0.4565900869,   0.3114517905,   0.6352901782,   0.1583679627,   0.6713485811,   0.0296032204,
            0.6502817619,   0.6459604742,   0.7786043362,   0.4393068845,   0.6078986069,   0.2625116665,   0.1507246209,   0.5752053898,   0.4347078857,   0.1446607924,   0.2235100885,   0.4810729257,   0.0104784864,   0.6767439520,   0.1138300058,   0.0472062029,
            0.4799699767,   0.6304455666,   0.8657342718,   0.0770349956,   0.7194267033,   0.7837052762,   0.8350612426,   0.5515214046,   0.6272435008,   0.1509639970,   0.4308311453,   0.2431834413,   0.0997720767,   0.6752484572,   0.8614708766,   0.9009357575,
            0.1895141699,   0.4620227032,   0.1693547422,   0.2082951564,   0.4794594674,   0.0822423499,   0.3990132480,   0.5959643316,   0.1779468696,   0.6763447475,   0.3599371279,   0.9612346717,   0.4059737766,   0.5641466764,   0.9954343890,   0.4171874129,
            0.0425833984,   0.0540071272,   0.5371547323,   0.2873574951,   0.8226849881,   0.5020610335,   0.1489799876,   0.8384884332,   0.7388816952,   0.9278419523,   0.5641628497,   0.3820900083,   0.8326136603,   0.6588944937,   0.9078872308,   0.4017193235,
            0.1817373699,   0.3727087814,   0.4432860147,   0.6738600856,   0.9283633113,   0.5603814837,   0.5794178636,   0.0068828072,   0.1595386130,   0.9694841290,   0.7809632169,   0.7349306270,   0.9411740395,   0.9759571257,   0.4769346644,   0.8890490950,
            0.8261404330,   0.3505585894,   0.6661011752,   0.3197748263,   0.4409391014,   0.8581853152,   0.5535988247,   0.0412579841,   0.8726396461,   0.6341205275,   0.7383709503,   0.3521814330,   0.9352832781,   0.7646946973,   0.8122629975,   0.7480396027,
            0.4112198033,   0.0640014732,   0.7011442097,   0.3008849650,   0.3125739260,   0.7376687457,   0.0744966206,   0.8233857550,   0.8731395296,   0.9005731670,   0.2010398383,   0.7303909104,   0.4818232831,   0.0840466909,   0.4620433427,   0.3189622358,
            0.7153241667,   0.9330117541,   0.8457839559,   0.7946904725,   0.9126972833,   0.3711149340,   0.6930361610,   0.1460545537,   0.2692749455,   0.6240418823,   0.4751983935,   0.9892039281,   0.9580399267,   0.3153115210,   0.8028770285,   0.4492842573,
            0.4732419552,   0.2968135567,   0.1743784830,   0.0218854145,   0.6078843833,   0.2592366971,   0.9925027230,   0.6145009247,   0.1567989724,   0.7588515493,   0.6525585436,   0.3318653874,   0.2434030446,   0.1502657524,   0.2757319549,   0.9072166120,
            0.1468804066,   0.6549598174,   0.8260999491,   0.9780442588,   0.0080245821,   0.0968652898,   0.3279050735,   0.8331170852,   0.0349013254,   0.1290463137,   0.8888058942,   0.0634963501,   0.8497077401,   0.7765090706,   0.4406566336,   0.5717883861,
            0.8801682038,   0.8070792613,   0.0111011665,   0.4337895336,   0.8305589060,   0.5731057557,   0.3888344421,   0.6650688049,   0.7173403874,   0.3643316657,   0.9761205754,   0.6465472403,   0.6913086199,   0.4378519886,   0.0511468898,   0.7815935504,
            0.0584501222,   0.2301810213,   0.5516453524,   0.8471224223,   0.8724711472,   0.3364354632,   0.9058224902,   0.4652837423,   0.9178211906,   0.6106574353,   0.4337526245,   0.0457454769,   0.0485558724,   0.4228905165,   0.5732351481,   0.7415249604,
            0.8815578938,   0.9099266419,   0.7819185764,   0.6804420118,   0.1141817828,   0.4578679616,   0.4744148939,   0.7521441020,   0.5836874799,   0.9627930788,   0.9284123824,   0.6765860430,   0.4644885608,   0.9307022026,   0.1067630655,   0.4764173078,
            0.6498208566,   0.9398550397,   0.3976048364,   0.7218604809,   0.6137449853,   0.3677245416,   0.5858759689,   0.6048287612,   0.7260422184,   0.5935331011,   0.7829400508,   0.0205522341,   0.3859927261,   0.7907605581,   0.2597055630,   0.7625952446,
            0.9974816033,   0.5594404994,   0.2341963798,   0.8674931147,   0.3087403816,   0.9555628563,   0.2866175376,   0.8840970914,   0.2728789319,   0.7268095885,   0.9593552932,   0.2941350526,   0.6335218542,   0.9964253322,   0.2191064166,   0.6735812945,
            0.6165513174,   0.4024065727,   0.3595163682,   0.1307470347,   0.5789277468,   0.4823191810,   0.3249827990,   0.9611755688,   0.1965910011,   0.8409298004,   0.3045483987,   0.3059512103,   0.5577756055,   0.7185979397,   0.1662346514,   0.4653240026,
            0.8962906854,   0.4101260882,   0.3929836636,   0.3283863430,   0.8915770367,   0.2627156919,   0.4191687562,   0.3023493466,   0.7052033601,   0.0316298807,   0.6993531516,   0.3295338820,   0.2671987668,   0.3418838158,   0.1231278391,   0.9860170942,
            0.7775898004,   0.9022957453,   0.8103332799,   0.1066592659,   0.8648613396,   0.0551683979,   0.0346967087,   0.2664932359,   0.3799035548,   0.5111612505,   0.4202829901,   0.0045376605,   0.6667662914,   0.9795484857,   0.1813452548,   0.4606982206,
            0.5207953859,   0.9762285538,   0.3831488273,   0.0158236536,   0.3282468531,   0.3889025738,   0.3192878043,   0.8350301921,   0.8137562924,   0.9274897214,   0.1726923312,   0.5932796473,   0.8523006079,   0.2105027967,   0.4583916454,   0.2116300024,
            0.8812492534,   0.0308930233,   0.0121518695,   0.6727324017,   0.5108330913,   0.9853691185,   0.3275486490,   0.6983914752,   0.8738750868,   0.2932906630,   0.4915305850,   0.6803218208,   0.0235163094,   0.1732825483,   0.3138590925,   0.4011225163,
            0.6043430449,   0.2004374033,   0.7958995462,   0.3443956097,   0.6559444951,   0.7976596794,   0.0678588344,   0.7308467695,   0.0929352865,   0.1770519900,   0.9113185328,   0.6222372961,   0.4649009312,   0.4366127113,   0.1295903325,   0.8688280633,
            0.3913629218,   0.0076760129,   0.1935744732,   0.2639093780,   0.3309006534,   0.7170830556,   0.2312584018,   0.0848557866,   0.6656051838,   0.1004909583,   0.5301618718,   0.0050040027,   0.9074698589,   0.7154495105,   0.3005780473,   0.4960185871,
            0.2223685959,   0.5305994998,   0.0190386116,   0.0176394444,   0.8322414465,   0.4685844639,   0.3146018769,   0.5285245721,   0.0467994251,   0.1034157446,   0.7111734389,   0.5238618170,   0.3928433864,   0.0646480693,   0.6417352352,   0.4164403209,
            0.4401488308,   0.8973846251,   0.4540344004,   0.7275178928,   0.9369716555,   0.7666257662,   0.7320253579,   0.0820943288,   0.3420996120,   0.4881523648,   0.9170160799,   0.7960658852,   0.1079977848,   0.4653047036,   0.2117796137,   0.3522110999,
            0.6819280630,   0.9328903880,   0.9896845422,   0.5031696298,   0.9597263460,   0.1368072351,   0.9252357199,   0.0423593986,   0.7606610943,   0.3984091372,   0.3668433806,   0.4122334932,   0.3960285631,   0.6334323846,   0.9755382616,   0.7549681795,
            0.9901663109,   0.7799347675,   0.5645032000,   0.1186202116,   0.7725932497,   0.3021364411,   0.1398717211,   0.5589964935,   0.4193140526,   0.1465805520,   0.1155421622,   0.7502099383,   0.6596698771,   0.4651328753,   0.9937038625,   0.8813698134,
            0.7228923635,   0.1414077428,   0.3910818306,   0.5087909737,   0.4846153786,   0.9369305556,   0.5087600945,   0.4983615917,   0.8203137506,   0.7721084783,   0.8473636551,   0.9155414042,   0.7155730078,   0.3180166087,   0.5620774425,   0.1567073557,
            0.3903452976,   0.3809912785,   0.6156024502,   0.5182074793,   0.8502709863,   0.2368653106,   0.0496853350,   0.8768593052,   0.1961554203,   0.0868933194,   0.5648802615,   0.1750243012,   0.9606368985,   0.1411932335,   0.6060477218,   0.8625311648,
            0.8209207558,   0.5823216603,   0.2774560250,   0.4182505483,   0.7996772680,   0.9006541607,   0.1998840914,   0.2659766895,   0.4665942506,   0.6487176509,   0.4847721020,   0.2719610409,   0.1221053165,   0.3201249604,   0.6207798384,   0.0158572141,
            0.2026605330,   0.8624603826,   0.7966935835,   0.5133003157,   0.0861735394,   0.3136224516,   0.0971842815,   0.2588690511,   0.3170700596,   0.8275769449,   0.0523168620,   0.9176390235,   0.7752428740,   0.2427238306,   0.5022820200,   0.6058205742,
            0.2022116448,   0.9843615411,   0.1854735177,   0.5786158277,   0.8047706758,   0.6062645244,   0.0470139262,   0.9765277539,   0.7203617898,   0.5052561598,   0.8449510389,   0.5713661142,   0.3821686957,   0.5207564095,   0.4151813809,   0.7158270359,
            0.3298331189,   0.8588059485,   0.7029820142,   0.3912689100,   0.2305508871,   0.5462546457,   0.1747788106,   0.2280154492,   0.1020060441,   0.8010391208,   0.6175484287,   0.6810268820,   0.8153803329,   0.7871741479,   0.1749836203,   0.7946854293,
            0.7255944537,   0.7474703813,   0.3543782059,   0.8660625877,   0.5028695841,   0.9028893760,   0.1297493624,   0.4789876140,   0.4659612625,   0.6442627324,   0.9310253739,   0.8274284793,   0.9036152093,   0.5462929982,   0.0735998654,   0.9436711008,
            0.9442038981,   0.2263951637,   0.5563454934,   0.0798341142,   0.1832900572,   0.1891035836,   0.2877697235,   0.9146164760,   0.8797851020,   0.0894535174,   0.2372037993,   0.2997882491,   0.9220593355,   0.6619261253,   0.9678196961,   0.4324329693,
            0.9156544870,   0.3915207038,   0.7807484018,   0.4997877098,   0.4256003145,   0.4381138884,   0.5718334967,   0.5958802902,   0.0654814213,   0.0674019791,   0.6656406802,   0.9902087488,   0.9006549743,   0.8823500273,   0.6888873399,   0.0878958496,
            0.5808413618,   0.5903648493,   0.2524541719,   0.9608727173,   0.9581228400,   0.8659240340,   0.5070567342,   0.5578132487,   0.7545976880,   0.4024102819,   0.3185194850,   0.3296206079,   0.7531167648,   0.1778827992,   0.1738617318,   0.7296453868,
            0.5321775579,   0.0585896086,   0.6286497897,   0.7507473731,   0.3376837977,   0.7713991906,   0.2089740485,   0.8155051847,   0.3283797675,   0.6323000396,   0.0566570884,   0.6791716011,   0.8983979443,   0.4839828125,   0.3168087456,   0.0530318085,
            0.8770772395,   0.8180792363,   0.8174742086,   0.0920927898,   0.8372128648,   0.7028597841,   0.8013947151,   0.9227490546,   0.9182225507,   0.4820722029,   0.1144164030,   0.5165688438,   0.7095836553,   0.9461455053,   0.1029472348,   0.3681356739,
            0.0706123640,   0.1925520048,   0.0069363826,   0.7640185194,   0.2582409341,   0.2660504753,   0.9070463993,   0.6837174120,   0.9592527592,   0.8340529043,   0.8531134340,   0.8622678843,   0.6170157218,   0.2088239607,   0.0559202879,   0.3843424280,
            0.8415790657,   0.3961201655,   0.7975636588,   0.2610993368,   0.1330949602,   0.1406977933,   0.5983807199,   0.0549428920,   0.8012566175,   0.6413986890,   0.8847719307,   0.7451581857,   0.3635295209,   0.8244543604,   0.3940531810,   0.1283773786,
            0.2333564020,   0.2949899655,   0.8798499085,   0.4931093750,   0.1965445542,   0.0158872545,   0.9873262525,   0.1410763345,   0.3859824176,   0.8973687511,   0.1880305188,   0.4661350481,   0.7044830225,   0.4973996509,   0.4330830102,   0.9290298779,
            0.4980133056,   0.4837048944,   0.5190648964,   0.1207169668,   0.5263312065,   0.1354013348,   0.9127206827,   0.9311613779,   0.4399032150,   0.4736157349,   0.9522045180,   0.9426062394,   0.7330127167,   0.1626503164,   0.1027705680,   0.2829552918,
            0.2783393401,   0.5832175213,   0.4099314930,   0.5163580766,   0.2481475410,   0.4209963073,   0.9003782845,   0.0532231105,   0.7839277873,   0.1140981757,   0.6178693917,   0.5177700595,   0.8766423707,   0.1965270950,   0.1474844929,   0.4289284097,
            0.7544018352,   0.5778000760,   0.3229492148,   0.5277061733,   0.1377497196,   0.0270021413,   0.1916048899,   0.8738096074,   0.3666639329,   0.8358394360,   0.2735454816,   0.5412835912,   0.8609129990,   0.8322227937,   0.8020634018,   0.5409954329,
            0.7549519194,   0.6315075919,   0.4154336937,   0.2988659400,   0.7351384462,   0.8174492551,   0.3478651899,   0.2882839998,   0.8784081225,   0.4278657773,   0.9809288914,   0.5000204698,   0.4486693994,   0.4170777642,   0.3603333101,   0.2694953399,
            0.0348203047,   0.1339332239,   0.4455683494,   0.5213781803,   0.9332382460,   0.6315728287,   0.3076205718,   0.8037015968,   0.0391042680,   0.6637989809,   0.4414971567,   0.0459138370,   0.3628432433,   0.8054350373,   0.7999585552,   0.1966120292,
            0.4386350213,   0.6389341741,   0.5100810931,   0.5577426635,   0.3230387894,   0.5019544393,   0.6330110880,   0.2990253414,   0.3167521189,   0.1779154950,   0.8002960598,   0.5585373264,   0.7750505775,   0.5442314097,   0.3116550338,   0.5414785518,
            0.4101143421,   0.7200749472,   0.5871191448,   0.3926239686,   0.0561544531,   0.8178479180,   0.8373667194,   0.8333663292,   0.5874133236,   0.7738176864,   0.5518811076,   0.5541072688,   0.5634170387,   0.3360212826,   0.0479818855,   0.9461223913,
            0.7129280732,   0.8021335231,   0.4311544456,   0.5775259408,   0.9212251923,   0.4072531259,   0.3845123524,   0.8539878791,   0.9830608360,   0.5331415564,   0.3437729945,   0.1072081654,   0.3325038944,   0.9048243260,   0.4289062757,   0.0703330878,
            0.1037624991,   0.9097686890,   0.0692284690,   0.6973798521,   0.7936130401,   0.3528202068,   0.6040365627,   0.2815500909,   0.5132792246,   0.6342095546,   0.9639194441,   0.4434066088,   0.2918707293,   0.3365671832,   0.7635659394,   0.2529750157,
            0.0867554430,   0.3254466765,   0.7988207350,   0.7369821499,   0.0863308884,   0.8459485655,   0.2184562055,   0.2799066262,   0.4317125049,   0.2572170861,   0.9480946401,   0.8720631991,   0.2820007795,   0.5847833208,   0.6625804278,   0.8962363466,
            0.6013856735,   0.3344323900,   0.5849921295,   0.8402030328,   0.1595154925,   0.0987129958,   0.0994814494,   0.7876193739,   0.4539033439,   0.9980564418,   0.4676883182,   0.2797558440,   0.5915597771,   0.9872175747,   0.3941710943,   0.3530616169,
            0.0822313189,   0.7014124832,   0.8783249772,   0.3513387675,   0.2249966479,   0.1869868453,   0.7413783947,   0.2093094047,   0.3635755154,   0.6768979645,   0.8119090252,   0.4432405668,   0.1286258175,   0.2226767623,   0.8817927083,   0.4642560104,
            0.4285207369,   0.8915916570,   0.2613970126,   0.8882712965,   0.5816268641,   0.3320637247,   0.8372590336,   0.0281126999,   0.7255949300,   0.2099189298,   0.6649443426,   0.9600017277,   0.9836679809,   0.5125477903,   0.4716796344,   0.5874884031,
            0.8586752823,   0.6076169260,   0.4966241305,   0.8549209747,   0.7892578061,   0.8368944512,   0.7800545896,   0.3301053398,   0.5798543607,   0.9837263032,   0.1477988730,   0.8935383741,   0.3406773747,   0.6451693231,   0.2569585679,   0.9923860289,
            0.6390879726,   0.5782565968,   0.8848319445,   0.9882538293,   0.8770123549,   0.1466844088,   0.8973527427,   0.8114790120,   0.4277738504,   0.0510962827,   0.4475099057,   0.8228107359,   0.7200810435,   0.1126089074,   0.4501000349,   0.6908830639,
            0.5905408570,   0.0877255524,   0.7897953527,   0.8692008427,   0.9856796984,   0.6184794437,   0.1036532025,   0.8801696314,   0.9560735290,   0.2190037865,   0.6511099525,   0.5666606782,   0.5057508439,   0.5270576492,   0.4436928880,   0.5266934826,
            0.2658647421,   0.6956284294,   0.3723431910,   0.2779611995,   0.6284161357,   0.3530489338,   0.4834056474,   0.0186059592,   0.4739627629,   0.2679895690,   0.7795134530,   0.0567489337,   0.4973734803,   0.4433209904,   0.6809479292,   0.1862131504,
            0.3791223247,   0.3685156163,   0.4708065953,   0.2418144809,   0.7463448070,   0.1420880900,   0.0186187132,   0.9257820141,   0.6213115498,   0.6585199867,   0.8190977637,   0.8043381340,   0.8238451570,   0.3840718446,   0.6702022434,   0.1138458395,
            0.9075028166,   0.8741980607,   0.1870750121,   0.7162669639,   0.4607795402,   0.7878628659,   0.3130479770,   0.1382153442,   0.6573340369,   0.4382623768,   0.9023219889,   0.2301849330,   0.2890861903,   0.3654998645,   0.7228275294,   0.5822589410,
            0.7340925674,   0.2983726123,   0.3231646346,   0.1120637728,   0.6961161792,   0.5715035790,   0.5542459263,   0.8356435448,   0.4967471626,   0.1280451454,   0.9783564782,   0.2897103569,   0.6662427412,   0.8568396811,   0.3921084513,   0.1836018065,
            0.2923643067,   0.9598792318,   0.8509532697,   0.0075323129,   0.2481513579,   0.5701366815,   0.3669250021,   0.5306200670,   0.3324260985,   0.7509356162,   0.3793237557,   0.1771000087,   0.6357396157,   0.7097712213,   0.1292498653,   0.1830480818,
            0.7336722485,   0.7265443672,   0.6290448496,   0.8937247919,   0.2503627685,   0.1276038096,   0.8458645300,   0.5449562828,   0.6391855744,   0.2307324881,   0.2605942854,   0.7466064543,   0.5973016954,   0.1821478725,   0.1469591970,   0.5406653777,
        ]);

    }
}
